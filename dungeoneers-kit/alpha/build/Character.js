var e=Object.defineProperty,t=Object.defineProperties,s=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,n=(t,s,r)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[s]=r,l=(e,t)=>{for(var s in t||(t={}))i.call(t,s)&&n(e,s,t[s]);if(r)for(var s of r(t))a.call(t,s)&&n(e,s,t[s]);return e},o=(e,r)=>t(e,s(r));import{g as c,U as h,V as u,W as g,X as p,d,Y as f,Z as m,_ as v,x as y,H as b,Q as C,$ as S,a0 as w,e as I,a1 as A,K as T,a2 as k,a3 as O,F,a4 as j,t as x,s as E,k as L,a5 as P,n as D,l as _}from"./index.js";function H(e,t){for(let s of t)R(e,s)}function R(e,t){for(let[s,r]of Object.entries(t))e[s]+=r;return e}class W extends Error{constructor(e,t){super(`Error with status '${e}'`),this.status=e,this.payload=t}getStatus(){return this.status}getPayload(){return this.payload}}class M extends W{}function U(e,t){return Object.assign(t,o(l({id:c(),UA:!1,entries:[],hash:c(),name:"(feature)",type:"custom",tracker:null},t),{getSourceString(){return void 0===this.source?"":this.source+" "+this.page},addToFeatures(){return e.features.addFeature(this)},removeFromFeatures(){return e.features.removeFeature(this)},getTracker(){return null===this.tracker?null:h(this.tracker,e)},addTracker(){return this.tracker=h({},e)},removeTracker(){this.tracker=null}}))}function N(e,t){return Object.assign(e,{getHitDiceSize(){return this.hd.faces},getDescriptionParts(){let e=[],t=this.getSubclass();return e.push(t?t.name:"(No subclass)"),this.isSpellCaster()&&e.push("Spellcaster"),e},addSpell(e){return t.spells.add(e,this.hash)},removeSpell(e){t.spells.remove(e,this.hash)},toggleSpell(e){return t.spells.toggleSpell(e,this.hash)},isSpellCaster(){let e=void 0!==this.spellcastingAbility,t=this.getSubclass(),s=null!==t&&void 0!==t.spellcastingAbility;return e||s},getSpellCastingStats(){if(!this.isSpellCaster())return null;let e=this.getSpellcastingSource().spellcastingAbility,s=t.stats.get()[e],r=p(s),i=r+t.proficiency.get();return{classObject:this,spellCastingAbility:e,score:s,modifier:r,spellAttackModifier:i,spellSaveDC:8+i}},getSpellcastingSource(){let e=this,t=this.getSubclass();return t&&void 0!==t.spellcastingAbility&&(e=t),e},getKnownCantrips(){return this.isSpellCaster()?this.getSpellcastingSource().cantripProgression[this.getLevel()-1]:0},getKnownSpells(){if(!this.isSpellCaster())return 0;let e=this.getSpellcastingSource();if(e.spellsKnownProgressionFixed){let t=e.spellsKnownProgressionFixed,s=0;for(let e=0;e<this.getLevel();e++)s+=t[e];return s}return e.spellsKnownProgression[this.getLevel()-1]},getMaxPreparableSpells(){if(!this.isSpellCaster()||void 0===this.preparedSpells)return null},getLevel(){return t.class.getClassEntry(this.hash).level},setLevel(e){return t.class.setLevel(this.hash,e)},setSubclass(e){return t.class.setSubclass(this.hash,e)},getSubclassHash(){var e;return null!=(e=t.class.getClassEntry(this.hash).subclass)?e:null},getSubclass(){let e=this.getSubclassHash();return g.getSubclass(this.hash,e)},canSelectSubclass(){return this.getLevel()>=this.getSubclassLevel()},getEntry(){return t.class.getClassEntry(this.hash)},getAvailableHitDice(){return this.getLevel()-this.getUsedHitDice()},getUsedHitDice(){return this.getEntry().usedHitDice}})}function $(e){return{getRaw:()=>e.get().classes,getCharacterLevel(){return this.getRaw().reduce(((e,t)=>e+t.level),0)},get(){return this.getRaw().map((({hash:t})=>N(d(f[t]),e)))},getClassEntry(e){"object"==typeof e&&(e=e.hash);let t=this.getRaw().find((t=>t.hash===e));return t||null},getClass(e){"object"==typeof e&&(e=e.hash);let t=this.get().find((t=>t.hash===e));return null!=t?t:null},getSpellCastingClasses(){return this.getRaw().filter((e=>{let t=g.get(e.hash),s=e.subclass?g.getSubclass(e.hash,e.subclass):null,r=void 0!==t.spellcastingAbility,i=s&&void 0!==s.spellcastingAbility;return r||i})).map((e=>this.getClass(e.hash)))},getSubclasses(){return this.getRaw().map((({hash:e,subclass:t})=>f[e].getSubclass(t)))},getAllFeatures(){let{UA:t}=e.get().settings;return this.getRaw().map((({hash:e,subclass:t})=>g.get(e).getClassFeatures(t))).flat(1).filter((e=>!e.UA||e.UA===t)).map((t=>U(e,t)))},getAvailableClassFeatures(){let{UA:t}=e.get().settings,s=e.features.getFeatureHashes();return this.getRaw().map((({hash:e,subclass:t,level:s})=>g.get(e).getClassFeatures(t).filter((e=>e.level<=s)))).flat(1).filter((e=>!e.UA||e===t)).filter((e=>!s.includes(e.hash))).map((t=>U(e,t)))},hasClass(e){return"object"==typeof e&&(e=e.hash),this.getRaw().map((({hash:e})=>e)).includes(e)},canChooseClass(t){return 0===this.get().length||("string"==typeof t&&(t=f[t]),[...this.get(),t].map((t=>function(e,t){if(void 0===t.multiclassing)return!1;let s=t.multiclassing.requirements;if(void 0!==s.or){let t=Object.entries(s.or),r=e.stats.get();for(let[e,s]of t)if(r[e]>=s)return!0;return!1}{let t=Object.entries(s),r=e.stats.get();for(let[e,s]of t)if(r[e]<s)return!1;return!0}}(e,t))).every((e=>e)))},addClass(t){if("object"==typeof t&&(t=t.hash),this.hasClass(t))throw new M("class_already_added");if(this.getCharacterLevel()+1>20)throw new M("level_limit_reached");return e.get().classes.push({hash:t,level:1,subclass:"",usedHitDice:0}),e.refresh(),N(this.getClass(t),e)},removeClass(t){"object"==typeof t&&(t=t.hash);let s=this.getRaw().map((({hash:e})=>e)).indexOf(t);return s<0?"classIsNotSelected":(e.get().classes.splice(s,1),e.refresh(),e.spells.removeSpellsFromClass(t),"success")},toggleClass(e){return"object"==typeof e&&(e=e.hash),this.hasClass(e)?this.removeClass(e):this.addClass(e)},setSubclass(t,s){"object"==typeof t&&(t=t.hash);let r=e.get().classes.find((e=>e.hash===t));r&&(r.subclass=s),e.refresh()},setLevel(t,s){"object"==typeof t&&(t=t.hash);let r=s-this.getClass(t).getLevel(),i=this.getCharacterLevel()+r;if(i<1)throw new M("cannot_decrease_lower_than_1");if(i>20)throw new M("cannot_increase_level_beyond_20");this.getClassEntry(t).level=s,e.refresh()},getSavingThrowProficiencies(){let e={};return this.get().forEach((t=>{t.proficiency.forEach((t=>e[t]=!0))})),e}}}const B=[v.Strength,v.Dexterity,v.Constitution,v.Intelligence,v.Wisdom,v.Charisma];class K extends W{}function q(e,t){return{name:e,overrideEnabled:!1,override:0,bonusEnabled:!1,bonus:0,categories:t}}var z,X;(X=z||(z={})).NONE="none",X.PROFICIENT="proficient",X.EXPERTISE="expertise";var G={version:1.5,id:"qfqef",dataset:null,editing:!1,name:"",settings:{UA:!1,includedSources:Object.keys(y)},classes:[],race:"",subrace:"",background:"",spells:[],spellSlots:{1:{slots:0,used:0},2:{slots:0,used:0},3:{slots:0,used:0},4:{slots:0,used:0},5:{slots:0,used:0},6:{slots:0,used:0},7:{slots:0,used:0},8:{slots:0,used:0},9:{slots:0,used:0}},preparedSpells:[],carriedItems:{name:"Carried items",id:"character",storedItems:[]},inventory:[],attunedItems:[],activeItems:[],additionalActions:[],armorClass:18,speed:30,health:{current:0,max:0,temp:0},deathSaves:{successes:0,failures:0},abilities:{str:10,dex:10,con:10,int:10,wis:10,cha:10},savingThrows:l({},Object.fromEntries(Object.entries(b).map((([e])=>[e,{proficiency:"none"}])))),skills:l({},Object.fromEntries(Object.entries(C).map((([e])=>[e,{name:S[e],proficiency:"none"}])))),features:[],selectedOptionalFeatures:[],pinnedSubFeatures:[],proficiencies:[],overrides:l({str:q("Strength ability score",["Ability score"]),dex:q("Dexterity ability score",["Ability score"]),con:q("Constitution ability score",["Ability score"]),int:q("Intelligence ability score",["Ability score"]),wis:q("Wisdom ability score",["Ability score"]),cha:q("Charisma ability score",["Ability score"]),maxCarryingCapacity:q("Max carrying capacity",["Misc"]),proficiencyBonus:q("Proficiency bonus",["Misc","Proficiency"]),speed:q("Speed",["Misc","Race"]),initiative:q("Initiative",["Combat"]),armorClass:q("Armor Class",["Combat"]),savingStr:q("Strength saving throw",["Saving Throw","Proficiency"]),savingDex:q("Dexterity saving throw",["Saving Throw","Proficiency"]),savingCon:q("Constitution saving throw",["Saving Throw","Proficiency"]),savingInt:q("Intelligence saving throw",["Saving Throw","Proficiency"]),savingWis:q("Wisdom saving throw",["Saving Throw","Proficiency"]),savingCha:q("Charisma saving throw",["Saving Throw","Proficiency"])},Object.fromEntries(Object.entries(C).map((([e])=>[e,q(`${S[e]} skill`,["Skill","Proficiency"])]))))};const Q={str:"savingStr",dex:"savingDex",con:"savingCon",int:"savingInt",wis:"savingWis",cha:"savingCha"},V=["none","proficient"];const Y={animalHandling:"Animal Handling",slightOfHand:"Slight of Hand"},Z=["none","proficient","expertise"];function J(e,t){return o(l({id:c(),storedItems:[]},e),{getMaxWeight(){return"character"===this.id?t.inventory.getMaxCarryingCapacity():null},getStoredItems(){return this.storedItems.map((e=>t.inventory.getInventoryItem(e)))},getWeight(){return this.getStoredItems().reduce(((e,t)=>e+t.getWeight()),0)},addItemToContainer(e){this.canContain(e)&&(e.currentContainer=this.id,this.storedItems.push(e.id),t.refresh())},removeItemFromContainer(e){let s=this.storedItems.indexOf(e.id);-1!==s&&(this.storedItems.splice(s,1),t.refresh())},canContain(e){let s=this.id!==e.id,r=this.id!==e.currentContainer,i=new Set;const a=e=>{for(let s of e){i.add(s);let e=t.inventory.getInventoryItem(s);a(e.storedItems)}};a(e.storedItems);let n=!i.has(this.id);return s&&r&&n},moveToThisContainer(e){this.canContain(e)&&(e.getCurrentContainer().removeItemFromContainer(e),this.addItemToContainer(e))}})}function ee(e,t){const s=J(e,t),r=A(e);return Object.assign(e,{id:c(),note:"",currentContainer:null,tracker:null,active:!1,attuned:!1},r,s,{inContainer(){return"character"!==this.currentContainer&&"void"!==this.currentContainer},getCurrentContainer(){return t.inventory.getContainer(this.currentContainer)},getMaxWeight(){let t=s.getMaxWeight();return this.isContainer()&&null===t?e.containerCapacity.weight[0]:null},getWeight(){var e;let t=r.getWeight();return(null==(e=r.containerCapacity)?void 0:e.weightless)||(t+=s.getWeight()),t},getCapacity:()=>s.getWeight(),getTracker(){return null===this.tracker?null:h(this.tracker,t)},addTracker(){return this.tracker=h({},t)},removeTracker(){this.tracker=null},asContainer(){return this.isContainer()?this:null},markAsActive(){t.inventory.markItemAsActive(this)},markAsInactive(){t.inventory.markItemAsInactive(this)},toggleActive(){t.inventory.toggleItemActive(this)},isActive(){return this.active}})}function te(e){const{characterStore:t}=e;let s={get:()=>t.get().inventory.map((t=>ee(t,e))),getWeapons(){return this.get().filter((e=>e.isWeapon()))},getInventoryItem(e){let t=this.get().find((t=>t.id===e));return void 0!==t?t:null},add(s){if(void 0===s)throw new Error("Argument should be an item or item hash");if("string"==typeof s&&void 0===(s=T[s]))throw new M("invalid_item_hash");let r=ee(d(s),e);return t.update((e=>(this.getCarriedContainer().addItemToContainer(r),e.inventory.push(r),e))),r},remove(e){if(void 0===e)throw new Error("Argument should be an id or an item object");"object"==typeof e&&(e=e.id);let s=this.get(),r=this.getInventoryItem(e),i=s.findIndex((t=>t.id===e));s.splice(i,1),this.removeAttunementTo(e),r.getCurrentContainer().removeItemFromContainer(r),r.getStoredItems().forEach((e=>{r.getCurrentContainer().moveToThisContainer(e)})),t.update((e=>(e.inventory=s,e)))},update(e){if(void 0===e.id)throw new Error("Expected an item with an id present");let s=this.get();s=s.map((t=>(t.id===e.id&&(t=l(l({},t),e)),t))),t.update((e=>(e.inventory=s,e)))},getCurrentCarryingCapacity(){return this.getCarriedContainer().getStoredItems().reduce(((e,t)=>e+t.getWeight()),0)},getMaxCarryingCapacity:()=>e.overrides.resolve("maxCarryingCapacity",15*e.stats.get().str),resolveItem:t=>("string"==typeof t&&(t=e.inventory.getInventoryItem(t)),t)};return function(e,t){const{characterStore:s}=t;Object.assign(e,{getCarriedItems(){let e={};const t=s=>{s.forEach((s=>{e[s]=!0;let r=this.getInventoryItem(s);t(r.storedItems)}))};return t(this.getCarriedContainer().storedItems),Object.keys(e).map((e=>this.getInventoryItem(e)))},getAllContainers(){return[this.getCarriedContainer(),...this.getContainers()]},getContainer(e){if(!e)return null;if("character"===e)return this.getCarriedContainer();let t=this.getInventoryItem(e);return(null==t?void 0:t.isContainer())?t:null},getCarriedContainer:()=>J(s.get().carriedItems,t),getContainers(){return this.get().filter((e=>e.isContainer()))}})}(s,e),function(e,t){Object.assign(e,{getActiveIds(){return this.getActiveItems().map((e=>e.id))},getActiveItems:()=>t.inventory.get().filter((e=>e.active)),markItemAsActive(e){(e=t.inventory.resolveItem(e)).active=!0,t.refresh()},markItemAsInactive(e){(e=t.inventory.resolveItem(e)).active=!1,t.refresh()},toggleItemActive(e){(e=t.inventory.resolveItem(e)).active?this.markItemAsInactive(e):this.markItemAsActive(e)},isItemActive:e=>(e=t.inventory.resolveItem(e)).active})}(s,e),function(e,t){Object.assign(e,{getAttunedSlots(){let e=t.inventory.getAttunedItems();for(;e.length<3;)e.push(null);return e},getAttunedItems:()=>t.inventory.get().filter((e=>e.attuned)),attuneToItem(e){e=t.inventory.resolveItem(e),t.inventory.canAttuneTo(e)&&(e.attuned=!0,t.refresh())},removeAttunementTo(e){(e=t.inventory.resolveItem(e)).attuned=!1,t.refresh()},toggleAttunementTo(e){e=t.inventory.resolveItem(e),t.inventory.canAttuneTo(e)&&(e.attuned=!e.attuned,t.refresh())},canAttuneTo:e=>!!(e=t.inventory.resolveItem(e)).reqAttune&&t.inventory.getAttunedItems().length<3,isAttunedTo:e=>(e=t.inventory.resolveItem(e)).attuned})}(s,e),s}function se(e){return{get(){return this.getRaw().map((t=>function(e,t){return Object.assign(e,o(l({},k(e)),{getAssociatedClass(){return t.class.getClass(this.associatedClass)},prepare(){t.spells.prepareSpell(this)},unPrepare(){t.spells.unprepareSpell(this)},togglePrepared(){t.spells.toggleSpellPrepared(this)},isPrepared(){return this.prepared}}))}(t,e)))},getRaw:()=>e.get().spells,getPreparedSpells(){return this.get().filter((e=>e.prepared))},getSpellsByClass(e){return this.get().filter((t=>t.associatedClass===e))},getSpellsByLevel(e){return this.get().filter((t=>t.level===e))},add(t,s){"string"==typeof t&&(t=k.resolve(t));let r="string"==typeof s?s:s.hash,i=e.class.getClass(r);if(!t)throw new M("no_spell");if(!i)throw new M("no_class");if(!i.isSpellCaster())throw new M("not_a_spellCaster");let a=d(t);return a.associatedClass=i.hash,a.prepared=0===a.level,e.get().spells.push(a),e.refresh(),this.get().find((e=>e.hash==e.hash))},remove:(t,s)=>t?s?("object"==typeof t&&(t=t.hash),void e.update((e=>(e.spells=e.spells.filter((e=>!(e.hash===t&&e.associatedClass===s))),e)))):"noClass":"noSpell",removeSpellsFromClass(t){e.update((e=>(e.spells=e.spells.filter((e=>e.associatedClass!==t)),e)))},toggleSpell(e,t){"string"==typeof e&&(e=O[e]),this.hasSpell(e,t)?this.remove(e,t):this.add(e,t)},hasSpell(e,t){return"object"==typeof e&&(e=e.hash),"object"==typeof t&&(t=t.hash),this.get().filter((s=>s.hash===e&&s.associatedClass===t)).length>0},prepareSpell(t){if(0===t.level)throw new M("cannot_prepare_cantrip");t.prepared=!0,e.refresh()},unprepareSpell(t){if(0===t.level)throw new M("cannot_unprepare_cantrip");t.prepared=!1,e.refresh()},toggleSpellPrepared(t){let s=this.getRaw().find((e=>e.hash===t.hash));s&&(s.prepared=!s.prepared),e.refresh()},getSpellCastingStatsForSpell(t){let s=t.getAssociatedClass();return function(e,t){let s=t.spellcastingAbility,r=e.stats.get()[s],i=p(r),a=i+e.proficiency.get();return{classObject:t,spellCastingAbility:s,score:r,modifier:i,spellAttackModifier:a,spellSaveDC:8+a}}(e,s)},getSpellCastingStats:()=>e.class.getSpellCastingClasses().map((e=>e.getSpellCastingStats())),classesSpellCanBeAddedTo(t){let s="string"==typeof t?t=O[t]:t,r=e.class.getSubclasses();return e.class.get().filter(((e,t)=>{let i=r[t],a=e.name.toLowerCase(),n=s.classes.fromClassList.some((e=>e.name.toLowerCase()===a)),l=null!==i&&s.classes.fromSubclass&&s.classes.fromSubclass.some((e=>e.class.name.toLowerCase()===a&&e.subclass.name.toLowerCase()===i.name.toLowerCase()));return n||l}))}}}function re(e,t,s,r,i){return"number"==typeof s&&(s=`${s} ft.`),"number"==typeof r&&(r=F(r)),{name:e,type:t,range:s,modifier:r,onHit:i}}function ie(e,t){let s=Object.entries(e);return s=s.filter((([e,s])=>ae(s,t))),Object.fromEntries(s)}function ae(e,t){let s=void 0!==e.UA&&!(e.UA&&!t.UA),r=e.UA||void 0!==e.source&&t.includedSources.includes(e.source.toLowerCase());return s&&r}function ne(e){return o(l(l({},e),j(e)),{getDescriptionParts(){let e=[];this.custom?e.push("Custom"):e.push(`${this.type} proficiency`);let t=this.getEntry();return null!==t&&(e=[...e,...t.getDescriptionParts()]),e},getEntry(){return null===this.hash||void 0===x[this.hash]?null:x[this.hash]}})}const le={customArmor:"armor",customWeapon:"weapon",customTool:"tool",customLanguage:"language"};var oe,ce;(ce=oe||(oe={})).Armor="armor",ce.Weapon="weapon",ce.Tool="tool",ce.Language="language",ce.CustomArmor="customArmor",ce.CustomWeapon="customWeapon",ce.CustomTool="customTool",ce.CustomLanguage="customLanguage";const he=L("charactersList",[]);function ue(){return he.get().map(ye)}function ge(){let e=c(9),t=he.get();t.push(e),he.set(t),location.href="#/character/"+e}const pe=new Map;pe.set(1.1,(e=>{let t={str:q("Strength ability score",["Ability score"]),dex:q("Dexterity ability score",["Ability score"]),con:q("Constitution ability score",["Ability score"]),int:q("Intelligence ability score",["Ability score"]),wis:q("Wisdom ability score",["Ability score"]),cha:q("Charisma ability score",["Ability score"])};e.overrides=l(l({},e.overrides),t)})),pe.set(1.2,(e=>{e.attunedItems=[]})),pe.set(1.3,(e=>{e.inventory=e.inventory.map((t=>(t.active=e.activeItems.includes(t.id),t.tracker&&(t.tracker.chargesUsed=t.tracker.maxCharges-t.tracker.charges,delete t.tracker.charges),t))),delete e.activeItems})),pe.set(1.4,(e=>{e.deathSaves={successes:0,failures:0}})),pe.set(1.5,(e=>{e.classes.forEach((e=>{e.usedHitDice=0}))}));class de{constructor(e){this.character=e}getCharacter(){return this.character}refresh(){this.character.refresh()}}class fe extends de{takeShortRest(e){if(e.resetTrackers&&this.getCharacter().trackers.rechargeTrackerTypes(P.SHORT_REST),e.useHitDice)for(let t of e.useHitDice)this.getCharacter().hitDice.useHitDie(t.hash,t.numberOfDiceToUse);this.refresh()}takeLongRest(e){if(e.resetHitDice)for(let t of this.getCharacter().class.getRaw())t.usedHitDice=0;e.resetMaxHealth,e.resetHealth&&this.getCharacter().health.heal(9999999),e.resetTempHealth&&this.getCharacter().health.setTemp(0),e.rechargeLongTrackers&&this.getCharacter().trackers.rechargeTrackerTypes(P.LONG_REST),e.rechargeDawnTrackers&&this.getCharacter().trackers.rechargeTrackerTypes(P.DAWN),e.rechargeSpellSlots&&this.getCharacter().spellSlots.resetSpellSlots(),this.refresh()}}class me extends de{useHitDie(e,t){let s=this.getCharacter().class.getClass(e);if(null===s)throw new M("noClass");let r=s.getLevel()-s.getUsedHitDice();t>r&&(t=r);let i=D(`${t}d${s.getHitDiceSize()}`);this.getCharacter().health.heal(i.diceTotal),s.getEntry().usedHitDice+=t,this.refresh()}}class ve extends de{rechargeTrackerTypes(e){let t=this.getAllTrackers().filter((t=>t.rechargeAt===e));for(let s of t)s.recharge()}getAllTrackers(){return[...this.getItemTrackers(),...this.getFeatureTrackers()]}getItemTrackers(){return this.getCharacter().inventory.get().filter((e=>null!==e.getTracker())).map((e=>e.getTracker()))}getFeatureTrackers(){return this.getCharacter().features.get().filter((e=>null!==e.getTracker())).map((e=>e.getTracker()))}}function ye(e){let t=L(`character_${e}`,d(G));t.get().id=e,t.set(function(e){let t=pe.entries(),{value:s}=t.next();for(;void 0!==s;){let[r,i]=s;e.version<r&&(i(e),e.version=r),s=t.next().value}return e}(t.get())),function(e){let t=he.get();t.includes(e)||(t.push(e),he.set(t))}(e),t.get().dataset||(t.get().dataset=_.get(),t.refresh());let s={characterStore:t,get:()=>t.get(),getId(){return this.get().id},getName(){let e=this.get().name;return e.length>0?e:"(No name)"},getDescription(){let e=this.race.get(),t=e?e.name:"(No race)",r=this.class.get(),i=`${t} ${r.length>0?r.map((e=>e.name)).join(" "):"(No class)"}`;return s.health.isDead()&&(i=`Dead ${i}`),i},getSpeed(){return this.get().speed},getArmorClass(){return this.get().armorClass},delete(){!function(e){let t=he.get(),s=t.indexOf(e);-1!==s&&t.splice(s,1),he.set(t)}(e),t.delete()},refresh(){t.refresh()},subscribe(e){return t.subscribe((t=>{e(this)}))},update(e){t.update(e)}};var r,i;return s.inventory=te(s),s.settings=function(e){const{characterStore:t}=e;return{get:()=>t.get().settings,getUA:()=>t.get().settings.UA,getIncludedSources:()=>t.get().settings.includedSources,toggleUA(){t.update((e=>(e.settings.UA=!e.settings.UA,e)))},setIncludedSources(e){t.update((t=>(t.settings.includedSources=e,t)))}}}(s),s.class=$(s),s.spells=se(s),s.spellSlots=function(e){const{characterStore:t}=e;return{get:()=>t.get().spellSlots,getList(){return Object.entries(this.get()).map((([e,t])=>(t.level=Number(e),t)))},getFilteredList(){return this.getList().filter((t=>t.slots>0||e.spells.getSpellsByLevel(t.level).length>0))},expendSpellSlot(e){let s=this.get()[e];s.used++,s.used>s.slots&&(s.used=s.slots),t.refresh()},regainSpellSlot(e){let s=this.get()[e];s.used--,s.used<0&&(s.used=0),t.refresh()},resetSpellSlots(){for(let e=1;e<=9;e++)this.get()[e].used=0;t.refresh()}}}(s),s.race=(r=s,{set(e){"object"==typeof e&&(e=e.hash),r.get().race=e,r.refresh()},setSubrace(e){"object"==typeof e&&(e=e.hash);let t=this.get();if(!t)throw new M("cannot_set_subrace_without_base_race");if(!t.subraces.find((t=>t.hash===e)))throw new M("subrace_is_not_part_of_base_race");r.get().subrace=e,r.refresh()},get(){let{race:e}=r.get();return u[e]||null},getSubrace(){let e=this.get();if(!e)return null;let t=r.get().subrace;return e.subraces.find((e=>e.hash===t))||null},getFeatures(){let e=this.get();return e?e.entries.map((e=>U(r,e))).map((e=>(e.type="race",e))):[]},getBonuses(){let e={str:0,dex:0,con:0,int:0,wis:0,cha:0},t=this.get();if(t){"ability"in t&&H(e,t.ability);let s=this.getSubrace();s&&"ability"in s&&H(e,s.ability)}return e},getSpeed(){let e=this.get();return e?r.overrides.resolve("speed",e.speed):0}}),s.stats=function(e){const{characterStore:t}=e;return{getBaseScores:()=>t.get().abilities,get(){let t=R(l({},this.getBaseScores()),e.race.getBonuses());return t=Object.fromEntries(Object.entries(t).map((([t,s])=>[t,s=e.overrides.resolve(t,s)]))),t},getModifiers(){let e=Object.entries(this.get());return e=e.map((([e,t])=>[e,p(t)])),Object.fromEntries(e)},getHighestScoreFrom(e=B){let t=this.get();return e.map((e=>t[e])).sort(((e,t)=>t-e))[0]},getHighestModifierFrom(e=B){return p(this.getHighestScoreFrom(e))}}}(s),s.proficiency=(i=s,{get(){let e=i.class.getCharacterLevel(),t=Math.floor((e-1)/4)+2;return i.overrides.resolve("proficiencyModifier",t)},getText(){return F(this.get())}}),s.skills=function(e){const{characterStore:t}=e;return{get(){let e=this.getFullSkills(),t=Object.entries(e);return t=t.map((([e,t])=>[e,t.value])),Object.fromEntries(t)},getFullSkills(){let s=e.stats.getModifiers(),r=e.proficiency.get(),i=t.get().skills,a=Object.entries(i);return a=a.map((([t,i])=>{let a=0;a+=s[C[t].basedOn],i.proficiency===z.PROFICIENT?a+=r:i.proficiency===z.EXPERTISE&&(a+=2*r);let n={id:t,name:t,value:e.overrides.resolve(t,a),proficiency:i.proficiency};return t in Y&&(n.name=Y[t]),n.name=I(i.name),[t,n]})),Object.fromEntries(a)},getFullSkillsList(){return Object.values(this.getFullSkills())},setProficiency(e,s){if("object"==typeof e&&(e=e.id),!Z.includes(s))throw new Error("Invalid proficiency value");let r=t.get();r.skills[e].proficiency=s,t.set(r)}}}(s),s.savingThrows=function(e){const{characterStore:t}=e;return{get(){let e=this.getFullSavingThrows();return Object.fromEntries(Object.entries(e).map((([e,t])=>[e,t.value])))},getFullSavingThrows(){let s=e.stats.getModifiers(),r=e.proficiency.get(),i=t.get().savingThrows,a=Object.entries(i);return a=a.map((([t,i])=>{let a=0;a+=s[t];let n=Q[t];a=e.overrides.resolve(n,a),i.proficiency===z.PROFICIENT&&(a+=r);let l={id:t,name:t,value:a,proficiency:i.proficiency};return t in w&&(l.name=w[t]),l.name=I(l.name),[t,l]})),Object.fromEntries(a)},getFullSavingThrowsList(){return Object.values(this.getFullSavingThrows())},setProficiency(e,s){if("object"==typeof e&&(e=e.id),!V.includes(s))throw new K("Invalid proficiency value");let r=t.get();r.savingThrows[e].proficiency=s,t.set(r)}}}(s),s.background=function({characterStore:e}){return{get(){let t=e.get().background;return m[t]}}}(s),s.features=function(e){const{characterStore:t}=e;return{get:()=>t.get().features.map((t=>U(e,t))),getClassFeatures(){return this.get().filter((e=>"class"===e.type||"subclass"===e.type)).sort(((e,t)=>e.level-t.level))},getRaceFeatures(){return this.get().filter((e=>"race"===e.type))},getSuggestedClassFeatures(){return this.filterFeatures(e.class.getAvailableClassFeatures())},getSuggestedRaceFeatures(){return this.filterFeatures(e.race.getFeatures())},filterFeatures(e){let t=this.get().map((e=>e.hash));return e.filter((e=>!t.includes(e.hash)))},getFeatureHashes(){return this.get().map((e=>e.hash))},addFeature(s){if(this.getFeatureHashes().includes(s.hash))throw new M("duplicateFeature");return s.id=c(),t.update((e=>(e.features.push(s),e))),U(e,s)},toggleOptionalFeature(e){let s=t.get();if(s.selectedOptionalFeatures.includes(e)){let t=s.selectedOptionalFeatures.indexOf(e);s.selectedOptionalFeatures.splice(t,1)}else s.selectedOptionalFeatures.push(e);t.set(s)},checkOptionalFeatureSelected:e=>t.get().selectedOptionalFeatures.includes(e),toggleSubFeaturePinned(e){let s=t.get();if(s.pinnedSubFeatures.includes(e)){let t=s.pinnedSubFeatures.indexOf(e);s.pinnedSubFeatures.splice(t,1)}else s.pinnedSubFeatures.push(e);t.set(s)},checkSubFeaturePinned:e=>t.get().pinnedSubFeatures.includes(e),removeFeature(e){let s=e;if("object"==typeof e&&(s=e.hash),!s)return"noFeature";let r=this.get(),i=null;for(let t=0;t<r.length;t++)r[t].hash===s&&(i=t);return null===i?"noFeature":(t.update((e=>(e.features.splice(i,1),e))),"success")}}}(s),s.actions=function(e){return{get(){return[re("Unarmed strike","Melee attack",5,e.stats.getModifiers().str,1),...this.getWeaponActions(),...this.getSpellActions()]},getWeaponActions:()=>e.inventory.getWeapons().filter((e=>e.isActive())).map((t=>re(t.name,t.getWeaponTypeString(),t.getRangeString(),t.getAttackBonus(e),t.getDamageExpression(e)))),getSpellActions:()=>e.spells.getPreparedSpells().map((e=>re(e.name,`Spell attack • ${e.getLevelString()}`,e.getRangeString(),0,0)))}}(s),s.health=function(e){const{characterStore:t}=e,s={getCurrent:()=>t.get().health.current,getMax:()=>t.get().health.max,getTemp:()=>t.get().health.temp,isDead:()=>3===t.get().deathSaves.failures,setCurrent(e){t.get().health.current=e,t.refresh()},setMax(e){t.get().health.max=e,t.refresh()},setTemp(e){t.get().health.temp=e,t.refresh()},heal(e=0){let s=this.getCurrent(),r=this.getMax();s+=e,s>r&&(s=r),t.get().health.current=s,t.refresh()},damage(e=0){let s=this.getCurrent(),r=this.getTemp();r>0&&((e-=r)<0?(r=Math.abs(e),e=0):r=0),s-=e,s<0&&(s=0),t.get().health.current=s,t.get().health.temp=r,t.refresh()}};let r=!1;return t.subscribe((e=>{if(r)return void(r=!1);let{current:s,max:i,temp:a}=e.health;i<0&&(i=0),a<0&&(a=0),s<0&&(s=0),s>i&&(s=i),null===s&&(s=0),e.health.current=null!=s?s:0,e.health.max=null!=i?i:0,e.health.temp=null!=a?a:0,s>0&&(e.deathSaves.successes=0,e.deathSaves.failures=0),t.refresh(),r=!0})),s}(s),s.includedData=function(e){return{getRaces:()=>ie(u,e.settings.get()),getClasses:()=>ie(f,e.settings.get()),getBackgrounds:()=>ie(m,e.settings.get()),getSpells:()=>ie(O,e.settings.get()),getItems:()=>ie(T,e.settings.get()),filterArray:(t=[])=>t.filter((t=>ae(t,e.settings.get())))}}(s),s.overrides=function(e){let{characterStore:t}=e;return{get:()=>t.get().overrides,getList(){return Object.entries(this.get()).map((([e,t])=>o(l({},t),{key:e})))},getCategories(){let e=[];return this.getList().forEach((t=>{t.categories.forEach((t=>{e.includes(t)||e.push(t)}))})),e},resolve(e,t){let s=this.get()[e];return void 0===s||(s.overrideEnabled&&(t=s.override),s.bonusEnabled&&(t+=s.bonus)),t}}}(s),s.proficiencies=function(e){const{characterStore:t}=e;return{add(e,s){let r=!1;if(void 0!==le[e]&&(e=le[e],r=!0),!Object.values(le).includes(e))throw new Error("Invalid proficiency type");let i={type:e,name:s,hash:null,custom:r},a=Object.values(E).find((e=>e.name.toLowerCase()===s.toLowerCase()));void 0!==a&&(i.hash=a.hash),t.update((e=>(e.proficiencies.push(i),e)))},remove(e){"object"==typeof e&&(e=e.name);let s=this.get().findIndex((t=>t.name===e));s>=0&&t.update((e=>(e.proficiencies.splice(s,1),e)))},get:()=>t.get().proficiencies.map(ne),getCategorized(){let e=this.get();return{armor:e.filter((e=>"armor"===e.type)),weapon:e.filter((e=>"weapon"===e.type)),tool:e.filter((e=>"tools"===e.type)),language:e.filter((e=>"language"===e.type))}},isProficientIn(e){return void 0!==this.get().find((t=>t.name===e))}}}(s),s.sleep=new fe(s),s.hitDice=new me(s),s.trackers=new ve(s),s}export{ye as C,z as P,ue as g,ge as n};
